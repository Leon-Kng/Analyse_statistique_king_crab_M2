---
title: "Rapport de projet MOST"
author: "Koenig Léon et Heier Noah"
date: "12/01/2024"
output:
  html_document:
    theme: readable
    toc: yes
    number_sections: yes
    toc_float: yes
    highlight: tango
  pdf_document:
    toc: yes
subtitle: ''
header-includes: \renewcommand{\contentsname}{Table des matières}
encoding: "UTF-8"
---

```{r setup, include=FALSE}
# Ce code, non inclus dans la sortie (car on a spécifié include = FALSE)
# permet de spécifier toutes les options par défaut pour les chunks
knitr::opts_chunk$set(echo = FALSE, # Ici, par défaut, les chunks seront invisibles
                      eval = TRUE, # Tous les chunks sont évalués par défaut
                      fig.align = "center", # Les figures sont centrées
                      fig.width = 8,
                      fig.height = 6, 
                      message = FALSE, # Les messages de R ne sont pas sortis
                      warning = FALSE) # Les avertissement de R ne sont pas sortis
```

```{r packages_utilises}
# Liste des package utilisés dans votre document (à compléter ou élaguer!)
library(dplyr) # Pour le %>% 
library(ggplot2) # Pour les graphiques
library(tidyr)
library(esquisse)
library(bestNormalize)
library(plotly)
library(gridExtra)
library(gganimate)
```

```{r chargement des données, echo=F}
rm(list=ls())
setwd("~/cours/M2/MOST/projet/KingCrab-20231110")
### CHARGEMENT DES DONNEES ##################
survey <- read.table("survey", stringsAsFactors=T)
survey <-rename(survey,year = V1, fishing_district = V2,Station_ID=V3,pots_fished=V4,latitude_halfway_pot=V5,longitude_halfway_pot=V6,pre_recruit_4=V7,pre_recruit_3=V8,pre_recruit_2=V9,pre_recruit_1=V10,recruit_males=V11,post_recruit=V12,juv_fem=V13,adu_fem=V14)

kodiak <- read.table("kodiak",stringsAsFactors=T)
kodiak <-rename(kodiak, latitude= V1, longitude = V2)

dstns <- read.table("dstns",stringsAsFactors=T)
dstns <-rename(dstns,year = V1, length_mm = V2 , count_juv_f=V3,count_adu_f=V4 ,count_males=V5)

fleet <- read.table("fleet",stringsAsFactors=T)
fleet <-rename(fleet,year= V1, nbr_vessels = V2, crabs_caught=V3,total_weight_caught=V4,total_pot_lifts=V5,price_pound=V6)

catch <- read.table("catch", stringsAsFactors=T)
catch <-rename(catch,year = V1,  district= V2, total_count=V3, total_kg=V4)

eggs <- read.table("eggs",stringsAsFactors=T)
eggs <-rename(eggs, year= V1, estim_eggs_per_adu_f=V2)

salinity <- read.table("salinity",stringsAsFactors=T)
salinity<-rename(salinity,year = V1, month = V2,salinity=V3)

celsius <- read.table("celsius",stringsAsFactors=T)
celsius <-rename(celsius,year = V1, month = V2,temp=V3)

fullness <- read.table("fullness",stringsAsFactors=T)
fullness <-rename(fullness, year= V1, size_mm= V2,fullness0=V3,fullness1_29=V4,fullness30_59=V5,fullness60_89=V6,fullness90_100=V7)

```
```{r modifcation des données, echo=F}

# Survey
survey$year <- paste0("19", survey$year) # ajout de 19 devant les nb pour avoir une année
survey$year <- as.numeric(survey$year)
survey$fishing_district <- as.factor(survey$fishing_district)
survey <- survey |> # on divise les données par le nb de casiers utilisés afin de tenir compte de l'effort d'échantillonnage
  mutate(year = year,
         fishing_district = fishing_district,
         Station_ID = Station_ID,
         pots_fished = pots_fished,
         latitude_halfway_pot = latitude_halfway_pot,
         longitude_halfway_pot = longitude_halfway_pot,
         pre_recruit_4_per_pot = pre_recruit_4/pots_fished,
         pre_recruit_3_per_pot = pre_recruit_3/pots_fished,
         pre_recruit_2_per_pot = pre_recruit_2/pots_fished,
         pre_recruit_1_per_pot = pre_recruit_1/pots_fished,
         recruit_males_per_pot = recruit_males/pots_fished,
         post_recruit_per_pot = post_recruit/pots_fished,
         juv_fem_per_pot = juv_fem/pots_fished,
         adu_fem_per_pot = adu_fem/pots_fished) |>  
  mutate(legal_males_per_pot = post_recruit_per_pot + recruit_males_per_pot,
         juv_males_per_pot = pre_recruit_1_per_pot + pre_recruit_2_per_pot + pre_recruit_3_per_pot + pre_recruit_4_per_pot,
         total_crabs_per_pot = juv_fem_per_pot + juv_males_per_pot + legal_males_per_pot + adu_fem_per_pot)

survey_simplified <- survey |> 
  group_by(year) |>
  summarise(legal_males = sum(legal_males_per_pot), 
            adu_fem = sum(adu_fem_per_pot),
            juv_fem = sum(juv_fem_per_pot),
            juv_males = sum(juv_males_per_pot),
            pre_recruit_1 = sum(pre_recruit_1_per_pot),
            pre_recruit_2 = sum(pre_recruit_2_per_pot),
            pre_recruit_3 = sum(pre_recruit_3_per_pot),
            pre_recruit_4 = sum(pre_recruit_4_per_pot),
            total_crabs = sum(total_crabs_per_pot),
            
            legal_males_pp = mean(legal_males_per_pot), 
            adu_fem_pp = mean(adu_fem_per_pot),
            juv_fem_pp = mean(juv_fem_per_pot),
            juv_males_pp = mean(juv_males_per_pot),
            pre_recruit_1_pp = mean(pre_recruit_1_per_pot),
            pre_recruit_2_pp = mean(pre_recruit_2_per_pot),
            pre_recruit_3_pp = mean(pre_recruit_3_per_pot),
            pre_recruit_4_pp = mean(pre_recruit_4_per_pot),
            total_crabs_pp = mean(total_crabs_per_pot)
  ) 

survey_long_category <- survey |> 
  select(year, legal_males_per_pot, adu_fem_per_pot, juv_fem_per_pot, juv_males_per_pot) |> 
  pivot_longer(cols = c(legal_males_per_pot, adu_fem_per_pot, juv_fem_per_pot, juv_males_per_pot), names_to = "crab_category", values_to = "nb_crabs_per_pot")

# Celsius
celsius$year <- paste0("19", celsius$year) # ajout de 19 devant les nb pour avoir une année

celsius <- celsius |>
  mutate(
    saison = case_when(
      month %in% c(12, 1, 2) ~ "hiver",
      month %in% c(3, 4, 5) ~ "printemps",
      month %in% c(6, 7, 8) ~ "été",
      month %in% c(9, 10, 11) ~ "automne",)) |>
  select(-month)
celsius$saison <- as.factor(celsius$saison)
celsius$year <- as.numeric(celsius$year)

celsius_simplified <- celsius |> 
  group_by(year, saison) |>
  summarize(temp_moy = mean(temp)) |> 
  pivot_wider(names_from = saison, values_from = temp_moy) |>
  rename(temp_moy_hiver = hiver,
         temp_moy_automne = automne,
         temp_moy_été = été,
         temp_moy_printemps = printemps)


celsius_simplified$year<- as.numeric(celsius_simplified$year)
df_global <- left_join(survey_simplified, celsius_simplified, by = "year")

celsius_more_simplified <- celsius |> 
  group_by(year) |>
  summarise(temp_moy = mean(temp, na.rm = TRUE)) # calcul de la température moyenne pour chaque année

celsius_more_simplified$year <- as.numeric(celsius_more_simplified$year)
df_global <- left_join(df_global, celsius_more_simplified, by = "year")


# Salinity
salinity$year <- paste0("19", salinity$year)
salinity$year<- as.numeric(salinity$year)
salinity$month<- as.factor(salinity$month)
salinity$salinity<- as.numeric(salinity$salinity)

salinity <- salinity |>
  mutate(saison = case_when(
    month %in% c(12, 1, 2) ~ "hiver",
    month %in% c(3, 4, 5) ~ "printemps",
    month %in% c(6, 7, 8) ~ "été",
    month %in% c(9, 10, 11) ~ "automne")) |> 
  select(-month)

salinity_simplified <- salinity |> 
  group_by(year, saison) |>
  summarize(sal_moy = mean(salinity)) |> 
  pivot_wider(names_from = saison, values_from = sal_moy) |>
  rename(sal_moy_hiver = hiver,
         sal_moy_automne = automne,
         sal_moy_été = été,
         sal_moy_printemps = printemps)
salinity$saison<- as.factor(salinity$saison)

df_global <- left_join(df_global, salinity_simplified, by = "year")

salinity_more_simplified <- salinity |> 
  group_by(year) |>
  summarise(sal_moy = mean(salinity, na.rm = TRUE)) # calcul de la salinité moyenne pour chaque année

salinity_more_simplified$year <- as.numeric(salinity_more_simplified$year)
df_global <- left_join(df_global, salinity_more_simplified, by = "year")


# Catch
catch$year <- paste0("19", catch$year)
catch$year <- as.numeric(catch$year)
catch_simplified <- catch |> 
  group_by(year) |>
  summarize(total_count = sum(total_count), 
            total_kg = sum(total_kg))


# Fleet 
fleet$year <- paste0("19", fleet$year)
fleet$year <- as.numeric(fleet$year)
fleet$prev_year <- fleet$year - 1
fleet_simplified <- fleet[,c(1,2,3)]
fleet_simplified$year <- fleet_simplified$year+1 # ajout d'une année puis on modifiera le nom de la colonne pour donner le nb de crabes pêchés l'année précédente
fleet_simplified <- rename(fleet_simplified, crabs_caught_last_year = crabs_caught)
fleet_simplified$year <- as.numeric(fleet_simplified$year)

df_global <- left_join(df_global, fleet_simplified, by = "year")
df_global <- left_join(df_global, fleet[,c(1,6)], by = "year") # ajout du prix à df_global

# Catch

diff_catch_fleet <- data.frame(year = fleet$year, delta_count = (fleet$crabs_caught - catch_simplified$total_count), delta_kg = fleet$total_weight_caught - catch_simplified$total_kg) # on compare fleet et catch pour être sûr que l'on a pas d'erreur
# on remarque que pour 1974 on a 2 valeurs pour le districts 1 mais différentes, pour corriger cela on peut faire une moyenne des 2 mais cela reste imparfait
catch[15,3:4] <- colSums(catch[c(15,16),3:4])/2
catch[39,3:4] <- colSums(catch[c(39,40),3:4])/2
catch[63,3:4] <- colSums(catch[c(63,64),3:4])/2
catch[87,3:4] <- colSums(catch[c(87,88),3:4])/2
catch <- catch[-c(16,40,64,88),]
catch$district <- as.factor(catch$district)

catch_simplified <- group_by(catch, year) |>
  summarize(total_count = sum(total_count), total_kg = sum(total_kg))

# Eggs
eggs$year <- paste0("19", eggs$year)
eggs$year <- as.numeric(eggs$year)
df_global <- left_join(df_global, eggs, by = "year")



# Dstns
dstns$year <- paste0("19", dstns$year)
dstns$year <- as.numeric(dstns$year)

dstns_sum <- dstns |>
  group_by(year) |>
  mutate(count_f = count_juv_f + count_adu_f)

dstns_simplified <- dstns_sum|> 
  summarize(
    length_moy_juv_F = sum(length_mm * count_juv_f) / sum(count_juv_f),
    length_moy_adu_F = sum(length_mm * count_adu_f) / sum(count_adu_f),
    length_moy_M = sum(length_mm * count_males) / sum(count_males),
    length_moy_F = sum(length_mm * count_f) / sum(count_f))

dstns_simplified_long <- dstns_simplified |> 
  select(-length_moy_adu_F, - length_moy_juv_F) |> 
  pivot_longer(cols = -year, 
               names_to = "category", 
               names_prefix = "length_moy_",
               values_to = "length_moy")

df_global <- left_join(df_global, dstns_simplified, by = "year")

# Fullness
fullness$year <- paste0("19", fullness$year)
fullness$year <- as.numeric(fullness$year)
fullness_simplified <- fullness |>
  group_by(year) |>
  summarize(
    size_moy_fullness0 = sum(size_mm*fullness0)/sum(fullness0),
    size_moy_fullness1_29 = sum(size_mm*fullness1_29)/sum(fullness1_29),
    size_moy_fullness30_59 = sum(size_mm*fullness30_59)/sum(fullness30_59),
    size_moy_fullness60_89 = sum(size_mm*fullness60_89)/sum(fullness60_89),
    size_moy_fullness90_100 = sum(size_mm*fullness90_100)/sum(fullness90_100),
    count_fullness0 = sum(fullness0),
    count_fullness1_29 = sum(fullness1_29),
    count_fullness30_59 = sum(fullness30_59),
    count_fullness60_89 = sum(fullness60_89),
    count_fullness90_100 = sum(fullness90_100)  )

df_global <- left_join(df_global, fullness_simplified, by = "year")

```

# Introduction

## King Crab

### Ecologie
Le King Crab d'Alaska, également connu sous le nom de crabe royal, est une espèce de crustacé décapode appartenant à la famille des Lithodidae.Ils se trouvent dans les eaux froides de l'océan Pacifique Nord, principalement dans les régions proches de l'Alaska, de la Russie et du Japon. Ils préfèrent les fonds marins riches en nutriments à des profondeurs allant jusqu'à plusieurs centaines de mètres.Ces crustacés ont une carapace dure et massive, pouvant atteindre une envergure importante. Ils se caractérisent par leurs pinces robustes et puissantes, utilisées pour la capture de proies et la défense. Leur régime alimentaire varie, mais il inclut généralement des mollusques, des petits poissons et d'autres organismes marins.

### Pèche
 Le King Crab d'Alaska est célèbre pour sa chair délicate et savoureuse, ce qui en fait une espèce prisée dans le secteur de la pêche commerciale. La pêche au crabe royal est une activité économiquement importante pour les communautés côtières de l'Alaska, de la Russie et d'autres régions où ces crustacés sont abondants. Ils sont exportés dans le monde entier pour répondre à la demande croissante de fruits de mer de qualité. La chair ferme et sucrée du King Crab en fait un produit recherché sur le marché international. De ce faite,une gestion durable de la pêche au crabe royal est cruciale pour préserver les populations et les écosystèmes marins. Des mesures de conservation strictes sont mises en œuvre pour assurer la durabilité de cette ressource précieuse.
 
## Zone d'étude
La zone d'étude dans laquelle ont été collectées les données à notre disposition est l'archipel de Kodiak, situé au sud de l'Alaska, au nord de l'océan Pacifique. Les îles Kodiak s'étendent sur environ 9 300 kilomètres carrés avec une topographie variée, comprenant des montagnes, des fjords, des rivières et des vallées. La pêche y joue un rôle essentiel dans l'économie. La région est particulièrement connue pour sa pêche au saumon, au crabe et à d'autres fruits de mer.

La carte ci-dessous montre l'île et l'emplacement des différents points de collecte en fonction des années (données provenant du fichier "survey"). L'île est séparée en quatre districts dans différentes parties de l'île.

```{r Carte, echo = F}
setwd("~/cours/M2/MOST/projet/KingCrab-20231110")


##### OUVERTURE ET MODIFICATION DES DONNEES #########################################

### Chargement des données ###
survey <- read.table("survey", stringsAsFactors=T)
survey <-rename(survey,year = V1, fishing_district = V2,Station_ID=V3,pots_fished=V4,latitude_halfway_pot=V5,longitude_halfway_pot=V6,pre_recruit_4=V7,pre_recruit_3=V8,pre_recruit_2=V9,pre_recruit_1=V10,recruit_males=V11,post_recruit=V12,juv_fem=V13,adu_fem=V14)

kodiak <- read.table("kodiak",stringsAsFactors=T)
kodiak <-rename(kodiak, latitude= V1, longitude = V2)

### Modification des données
survey$year <- paste0("19", survey$year) # ajout de 19 devant les nb pour avoir une année
survey$year <- as.factor(survey$year)
survey$legal_males <- survey$post_recruit + survey$recruit_males
survey$Total_crabs <- rowSums(survey[, 7:14], na.rm = TRUE) # calcul du nb total de crabes attrapés
survey_count <- survey %>%
  group_by(year) %>%
  summarise(Nb_legal_males = sum(legal_males))
survey$fishing_district <- as.factor(survey$fishing_district)




##### METHODE PLOTLY ######################################################################################################

# Définir les limites x et y pour conserver les mêmes échelles sur chaque graphique
x_limits <- range(-kodiak$longitude)
y_limits <- range(kodiak$latitude)

# Créer un graphique de base avec Plotly
base_plot <- plot_ly() %>%
  add_trace(
    data = kodiak,
    x = ~-longitude,
    y = ~latitude,
    type = 'scatter',
    mode = 'lines',
    line = list(color = 'black'),
    showlegend = FALSE
  ) %>%
  layout(
    xaxis = list(title = "Longitude"),
    yaxis = list(title = "Latitude"),
    title = "Carte interactive des îles de Kodiak"
  )

# Créer une liste pour stocker les données de chaque année
data_by_year <- lapply(unique(survey$year), function(yr) {
  survey_year <- subset(survey, year == yr)
  list(
    x = -survey_year$longitude_halfway_pot,
    y = survey_year$latitude_halfway_pot,
    size = survey_year$Total_crabs,
    color = survey_year$fishing_district,
    text = paste("Année: ", yr, "<br>Total Crabs: ", survey_year$Total_crabs)
  )
})

# Ajouter les données de chaque année au graphique de base pour chaque frame
for (i in seq_along(data_by_year)) {
  base_plot <- base_plot %>%
    add_trace(
      data = data_by_year[[i]],
      x = ~x,
      y = ~y,
      type = 'scatter',
      mode = 'markers',
      size = ~size,
      color = ~color,
      text = ~text,
      frame = unique(survey$year)[i]
    )
}

base_plot %>%
  animation_opts(frame = 500, redraw = TRUE, transition = 0) %>%
  animation_slider(
    currentvalue = list(prefix = "Année: "),
    steps = lapply(
      seq_along(data_by_year),
      function(i) list(
        label = unique(survey$year)[i],
        method = "animate",
        args = list(list("frame", list(duration = 0)), list("transition", list(duration = 0)))
      )
    )
  ) %>%
  layout(
    hovermode = "closest", # Afficher les informations au survol du point le plus proche
    hoverinfo = "text"     # Afficher les informations définies dans 'text' au survol
  )
```
## Jeux de donnée

### Provenance
Tous les ensembles de données, sauf la salinité et la température, ont été fournis par le Département de la Pêche et du Jeu de l'Alaska, 211 Mission Road, Kodiak, AK 99615. Les données de salinité et de température proviennent de Tom Royer, Institut des Sciences Marines, Université d'Alaska, Fairbanks, AK 99775-1080. Il y a aussi des statistiques sur la flotte de pêche et les captures commerciales, pour chaque année entre 1960 et 1982, ainsi que des données de captures commerciales pour la période 1960-1982, réparties par district (les 4 zones sur la carte).

### Modification apporter

## Observation préliminaire
```{r graphique préliminiare, echo=F}

# Votre code de base pour créer le tracé ggplot pour chaque variable avec courbes de tendance
plot1 <- ggplot(df_global, aes(x = year, y = total_crabs)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "black") +  # Ajouter une courbe de tendance linéaire
  labs(title = "Nombre total de crabe") +
  theme(axis.title.y = element_blank(),plot.title = element_text(hjust = 0.5))  # Supprimer le nom de l'axe des abscisses

plot2 <- ggplot(dstns_simplified_long, aes(x = year, y = length_moy, color = category))+ # Longueur moyenne augmente de manière significative avec le temps
  geom_point() +
  labs(title = "Taille des Crabes mâles et femelle
       au cours du temps") +
  geom_smooth(method = "lm", se = F)+
  theme(axis.title.y = element_blank(),plot.title = element_text(hjust = 0.1)) 

# Création du graphique avec ggplot2
plot3<-df_global %>%
 filter(year >= 1973L & year <= 1982L) %>%
 ggplot() + aes(x = year, y = price_pound) +
  geom_point() +  # Ajout des points
  geom_smooth(method = "lm", se = F, color = "orange") +
  labs(x = "Année", y = "Prix par livre", title = "Évolution du prix par livre au fil des années") +
  theme(axis.title.y = element_blank(), plot.title = element_text(hjust = 0.5))

plot4<-fleet %>%
  filter(year >= 1964L & year <= 1982L) %>%
  ggplot() +
  aes(x = year, y = total_pot_lifts) +
  geom_point(shape = "circle", size = 1.5, colour = "#112446") +
  labs(title = "Nombres total de casier soulevés par année
       (effort de pêche)")+
  geom_smooth(method = "lm",se = FALSE, color = "#99CC33") +
  theme(axis.title.y = element_blank(),plot.title = element_text(hjust = 0.5))
  

# Afficher les graphiques dans une disposition de grille (2 lignes, 2 colonnes)
grid.arrange(plot1, plot2, plot3,plot4, ncol = 2, nrow = 2)

```

## Problématique et hypothèse
Suite à ces observation, plusieur question nous sont apparu.

Dans un premier temps, nous veront si les variation de température et de salinité liée au rechauffement climatique sont significative. 

Puis nous veront si ces paramètres abiotique influence la biologie des King crabe, leur taille, leur nombre ou leur nombre d’oeuf. 

Enfin, essayeront de voir si l’effort de peche augment et si cela peut aussi impacter les population de crabe dans les îles Kodiak


# Résultat

```{r, echo=F,out.height="50%"}
plot5<-ggplot(celsius, aes(x = year, y = temp, color = saison))+
  geom_point()+
  labs(title = "Température (°C)")+
  labs(x = "Année", y = "Température de l'eau à 100m de profondeur (en °C)", color = "Saison")+
  geom_smooth(method="lm", se=F)+
theme(legend.position = "none",axis.title.y = element_blank(),plot.title = element_text(hjust = 0.5))

plot6<-ggplot(salinity, aes(x = year, y = salinity, color = saison))+
  geom_point()+
    labs(title = "Salinité (ppt)")+
  labs(x = "Année", y = "Salinité de l'eau à 100m de profondeur (en parties par milliers)", color = "Saison")+
  theme(legend.position = c(0.95, 0.74), 
        legend.justification = c(1, 0),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))+
  geom_smooth(method="lm", se=F) # faire une ancova avec la salinité en fonction de l'année et de la saison puis tester l'effet de la salinté sur les variables de survey
grid.arrange(plot5, plot6, ncol = 2, nrow = 1)
```

Pour tout $i$ allant de 1 à 13, et $j$ allant de 1 à 4  on suppose que $y_{ij}$ est la réalisation d'une variable aléatoire $Y_{ij}$ telle que:

$$Y_{ij} = \beta_{0}+\beta_{1}*\alpha_{i} + \beta_{2}*\gamma_{j}+\beta_{3}*x_{ij} + E_{ijk}$$
avec : 
$$E_{ijk} \overset{i.i.d}{\sim} \mathcal{N}(0, \sigma^2)$$
où:

- $\alpha_{i}$ , $\gamma_{j}$ et $x_{ij}$sont respectivement les années, les saisons et l’intéraction des deux.
- $E_k$ suis une loi normal d'espérance 0 et de variance $\sigma^2$
```{r code modèle température, echo=T,fig.show='hide'}
ancova_temp <- lm(temp ~ year*saison, data = celsius)
shapiro.test(ancova_temp$residuals)
par(mfrow=c(2,2))
plot(ancova_temp)
anova(ancova_temp) # *** year et saison
```


# Discussion / Ouverture
